{% extends "base.html" %} {% block content %}

<div class="container-fluid dashboard">
  <div class="row mb-5">
    <div class="col-sm-12 col-md-4">
      <div class="card bg-primary text-white h-100">
        <div class="card-body body1">
          <h5 class="card-title">Total Income</h5>
          <h2 class="card-text" id="totalIncome">Loading...</h2>
        </div>
      </div>
    </div>
    <div class="col-sm-12 col-md-4">
      <div class="card bg-success text-white h-100">
        <div class="card-body body2">
          <h5 class="card-title">Total Expenses</h5>
          <h2 class="card-text" id="totalAllocation">Loading...</h2>
        </div>
      </div>
    </div>
    <div class="col-sm-12 col-md-4">
      <div class="card bg-info text-white h-100">
        <div class="card-body body3">
          <h5 class="card-title">Net Cash Flow</h5>
          <h2 class="card-text" id="netCashFlow">Loading...</h2>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-5">
    <!-- Income Section -->
    <div class="col-md-7 col-lg-8 border-cashflow">
      <form method="POST" action="{{ url_for('finData.cash_income') }}">
        {{ income_form.hidden_tag() }}
        <div class="row g-3">
          <h4 class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-primary">Income</span>
          </h4>
          <div class="col-sm-6">
            {{ income_form.title_income.label(class="form-control-label") }} {%
            if income_form.title_income.errors %} {{
            income_form.title_income(class="form-control form-control-lg
            is-invalid") }}
            <div class="invalid-feedback">
              {% for error in income_form.title_income.errors %}
              <span>{{ error }}</span>
              {% endfor %}
            </div>
            {% else %} {{ income_form.title_income(class="form-control
            form-control-lg") }} {% endif %}
          </div>
          <div class="col-sm-6">
            {{ income_form.amount_income.label(class="form-control-label") }} {%
            if income_form.amount_income.errors %} {{
            income_form.amount_income(class="form-control form-control-lg
            is-invalid") }}
            <div class="invalid-feedback">
              {% for error in income_form.amount_income.errors %}
              <span>{{ error }}</span>
              {% endfor %}
            </div>
            {% else %} {{ income_form.amount_income(class="form-control
            form-control-lg") }} {% endif %}
          </div>
          <div class="col-sm-6">
            {{ income_form.date_income.label(class="form-control-label") }} {%
            if income_form.date_income.errors %} {{
            income_form.date_income(class="form-control form-control-lg
            is-invalid") }}
            <div class="invalid-feedback">
              {% for error in income_form.date_income.errors %}
              <span>{{ error }}</span>
              {% endfor %}
            </div>
            {% else %} {{ income_form.date_income(class="form-control
            form-control-lg") }} {% endif %}
          </div>
          <div class="input-group">
            {{ income_form.submit_income(class="btn btn-secondary") }}
          </div>
          <hr class="my-4" />
        </div>
      </form>

      <h2 class="mt-4">Income Records</h2>
      <div class="table-responsive small">
        <table class="table" id="incomeTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Income</th>
              <th>Amount</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for income in incomes %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ income.title_income }}</td>
              <td>
                {{ format_currency(income['amount_income'], project.currency) }}
              </td>
              <td>{{ income.date_income }}</td>
              <td>
                <button
                  class="btn btn-danger btn-sm delete-record"
                  data-type="income"
                  data-id="{{ income.id }}"
                >
                  Delete
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <nav aria-label="Income pagination" class="mt-3">
        <ul
          class="pagination justify-content-center"
          id="incomePagination"
        ></ul>
      </nav>

      {% if incomes|length > 8 %}
      <button
        class="btn btn-primary mt-3"
        data-bs-toggle="modal"
        data-bs-target="#allRecordsIncomeModal"
      >
        Show All Income Records
      </button>
      {% endif %}
    </div>
    <!-- Allocation Section -->
    <div class="col-md-7 col-lg-8 border-cashflow">
      <h4 class="d-flex justify-content-between align-items-center mb-3">
        <span class="text-primary-expenses">Allocation</span>
      </h4>

      <div class="btn-group mb-3" role="group" aria-label="Expense types">
        <button
          type="button"
          class="btn btn-outline-primary active"
          id="expensesBtn"
        >
          Expenses
        </button>
        <button type="button" class="btn btn-outline-primary" id="savingsBtn">
          Savings/Aims
        </button>
        <button
          type="button"
          class="btn btn-outline-primary"
          id="investmentsBtn"
        >
          Investments
        </button>
      </div>

      <div id="expensesForm">
        <form method="POST" action="{{ url_for('finData.cash_income') }}">
          {{ expense_form.hidden_tag() }}
          <div class="row g-3">
            <div class="col-sm-6">
              {{ expense_form.title_expense.label(class="form-control-label") }}
              {{ expense_form.title_expense(class="form-control
              form-control-lg") }}
            </div>
            <div class="col-sm-6">
              {{ expense_form.amount_expense.label(class="form-control-label")
              }} {{ expense_form.amount_expense(class="form-control
              form-control-lg") }}
            </div>
            <div class="col-sm-6">
              {{ expense_form.date_expense.label(class="form-control-label") }}
              {{ expense_form.date_expense(class="form-control form-control-lg")
              }}
            </div>
            <div class="input-group">
              {{ expense_form.submit_expense(class="btn btn-secondary") }}
            </div>
          </div>
        </form>
      </div>

      <div id="savingsForm" style="display: none">
        <!-- Add savings form here (similar to expense form) -->
        <form method="POST">
          {{ savings_form.hidden_tag() }}
          <div class="row g-3">
            <div class="col-sm-6">
              {{ savings_form.title_savings.label(class="form-control-label") }}
              {{ savings_form.title_savings(class="form-control
              form-control-lg") }}
            </div>
            <div class="col-sm-6">
              {{ savings_form.amount_savings.label(class="form-control-label")
              }} {{ savings_form.amount_savings(class="form-control
              form-control-lg") }}
            </div>
            <div class="col-sm-6">
              {{ savings_form.date_savings.label(class="form-control-label") }}
              {{ savings_form.date_savings(class="form-control form-control-lg")
              }}
            </div>
            <div class="input-group">
              {{ savings_form.submit_savings(class="btn btn-secondary") }}
            </div>
          </div>
        </form>
      </div>

      <div id="investmentsForm" style="display: none">
        <!-- Add investments form here -->
        <form method="POST">
          {{ investments_form.hidden_tag() }}
          <div class="row g-3">
            <div class="col-sm-6">
              {{ investments_form.stock.label(class="form-control-label") }} {{
              investments_form.stock(class="form-control form-control-lg") }}
            </div>
            <div class="col-sm-6">
              {{
              investments_form.amount_investment.label(class="form-control-label")
              }} {{ investments_form.amount_investment(class="form-control
              form-control-lg") }}
            </div>
            <div class="col-sm-6">
              {{
              investments_form.date_investment.label(class="form-control-label")
              }} {{ investments_form.date_investment(class="form-control
              form-control-lg") }}
            </div>
            <div class="input-group">
              {{ investments_form.submit_investment(class="btn btn-secondary")
              }}
            </div>
          </div>
        </form>
      </div>

      <!-- Keep the existing expenses records table here -->
      <h2 class="mt-4">Latest Allocation Records</h2>
      <div class="table-responsive small">
        <table class="table" id="allocationTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Title</th>
              <th>Amount</th>
              <th>Date</th>
              <th>Type</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% set combined_records = (expenses or []) + (savings or []) +
            (investments or []) %} {% for record in combined_records |
            sort(attribute='date', reverse=True) %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>
                {% if record.__class__.__name__ == 'Expense' %} {{
                record.title_expense }} {% elif record.__class__.__name__ ==
                'Savings' %} {{ record.title_savings }} {% elif
                record.__class__.__name__ == 'Investment' %} {{ record.stock }}
                {% endif %}
              </td>
              <td>
                {% if record.__class__.__name__ == 'Expense' %} {{
                format_currency(record.amount_expense, project.currency) }} {%
                elif record.__class__.__name__ == 'Savings' %} {{
                format_currency(record.amount_savings, project.currency) }} {%
                elif record.__class__.__name__ == 'Investment' %} {{
                format_currency(record.amount_investment, project.currency) }}
                {% endif %}
              </td>
              <td>
                {% if record.__class__.__name__ == 'Expense' %} {{
                record.date_expense }} {% elif record.__class__.__name__ ==
                'Savings' %} {{ record.date_savings }} {% elif
                record.__class__.__name__ == 'Investment' %} {{
                record.date_investment }} {% endif %}
              </td>
              <td>
                {% if record.__class__.__name__ == 'Expense' %} Expense {% elif
                record.__class__.__name__ == 'Savings' %} Savings/Aims {% elif
                record.__class__.__name__ == 'Investment' %} Investment {% endif
                %}
              </td>
              <td>
                <button
                  class="btn btn-danger btn-sm delete-record"
                  data-type="{{ record.__class__.__name__.lower() }}"
                  data-id="{{ record.id }}"
                >
                  Delete
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <nav aria-label="Allocation pagination" class="mt-3">
        <ul
          class="pagination justify-content-center"
          id="allocationPagination"
        ></ul>
      </nav>

      {% if combined_records|length > 8 %}
      <button
        class="btn btn-primary mt-3"
        data-bs-toggle="modal"
        data-bs-target="#allRecordsAllocationModal"
      >
        Show All Allocation Records
      </button>
      {% endif %}
    </div>
  </div>
</div>

<!-- Income Modal -->
<div
  class="modal fade"
  id="allRecordsIncomeModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="allRecordsIncomeModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-primary" id="allRecordsIncomeModalLabel">
          All Income Records
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>#</th>
                <th>Income</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for income in incomes %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ income.title_income }}</td>
                <td>
                  {{ format_currency(income['amount_income'], project.currency)
                  }}
                </td>
                <td>{{ income.date_income }}</td>
                <td>
                  <button
                    class="btn btn-danger btn-sm delete-record"
                    data-type="income"
                    data-id="{{ income.id }}"
                  >
                    Delete
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Allocation Modal -->
<div
  class="modal fade"
  id="allRecordsAllocationModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="allRecordsAllocationModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5
          class="modal-title text-primary"
          id="allRecordsAllocationModalLabel"
        >
          All Allocation Records
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>#</th>
                <th>Title</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Type</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for record in sorted_records %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>
                  {% if record.__class__.__name__ == 'Expense' %} {{
                  record.title_expense }} {% elif record.__class__.__name__ ==
                  'Savings' %} {{ record.title_savings }} {% elif
                  record.__class__.__name__ == 'Investment' %} {{ record.stock
                  }} {% endif %}
                </td>
                <td>
                  {% if record.__class__.__name__ == 'Expense' %} {{
                  format_currency(record.amount_expense, project.currency) }} {%
                  elif record.__class__.__name__ == 'Savings' %} {{
                  format_currency(record.amount_savings, project.currency) }} {%
                  elif record.__class__.__name__ == 'Investment' %} {{
                  format_currency(record.amount_investment, project.currency) }}
                  {% endif %}
                </td>
                <td>
                  {% if record.__class__.__name__ == 'Expense' %} {{
                  record.date_expense }} {% elif record.__class__.__name__ ==
                  'Savings' %} {{ record.date_savings }} {% elif
                  record.__class__.__name__ == 'Investment' %} {{
                  record.date_investment }} {% endif %}
                </td>
                <td>
                  {% if record.__class__.__name__ == 'Expense' %} Expense {%
                  elif record.__class__.__name__ == 'Savings' %} Savings/Aims {%
                  elif record.__class__.__name__ == 'Investment' %} Investment
                  {% endif %}
                </td>
                <td>
                  <button
                    class="btn btn-danger btn-sm delete-record"
                    data-type="{{ record.__class__.__name__.lower() }}"
                    data-id="{{ record.id }}"
                  >
                    Delete
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
